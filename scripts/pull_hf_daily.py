"""
pull_hf_daily.py

This script pulls the daily papers from Hugging Face's papers page, downloads their PDFs,
and saves their information in a JSON file.
"""

# Standard library imports
import json
import os
import re
from datetime import datetime
from typing import List, Dict, Optional

# Third party imports
import requests
from bs4 import BeautifulSoup

HF_URL = "https://huggingface.co/papers"


def download_pdf(arxiv_id: str, save_path: str) -> bool:
    """
    Downloads the PDF of a paper from arXiv given its ID.

    Args:
        arxiv_id (str): The arXiv ID of the paper.
        save_path (str): The path where the PDF will be saved.

    Returns:
        bool: True if the download was successful, False otherwise.
    """
    url = f"https://arxiv.org/pdf/{arxiv_id}.pdf"
    response = requests.get(url)
    if response.status_code == 200:
        with open(save_path, "wb") as f:
            f.write(response.content)
        return True
    return False


def pull_hf_daily(date: Optional[str] = None) -> None:
    """
    Pulls the daily papers from Hugging Face's papers page, downloads their PDFs,
    extracts GitHub and Hugging Face links, and saves their information in a JSON file.

    Parameters:
    - date (str, optional): Date for the file naming convention (YYYY-MM-DD).
                            Defaults to today's date if not specified.
    """
    # Use today's date if not specified
    if not date:
        date = datetime.now().strftime("%Y-%m-%d")

    response = requests.get(f"{HF_URL}?date={date}")
    soup = BeautifulSoup(response.content, "html.parser")

    papers: List[Dict[str, str]] = []
    seen_ids = set()  # Set to track seen arXiv IDs
    temp_pdf_dir = "temp_pdfs"
    os.makedirs(
        temp_pdf_dir, exist_ok=True
    )  # Create temp_pdfs directory if it doesn't exist

    # Locate the relevant div elements
    for paper_div in soup.find_all("div", class_="w-full"):
        # Extract the title
        title_tag = paper_div.find("a", class_="line-clamp-3")
        if title_tag:
            title = title_tag.text.strip()
        else:
            print("Title not found for a paper")
            continue

        # Extract the paper ID from the link
        link = title_tag["href"]
        arxiv_id_match = re.search(r"/papers/(\d+\.\d+)", link)
        if arxiv_id_match:
            arxiv_id = arxiv_id_match.group(1)
        else:
            print(f"Could not extract arXiv ID from link: {link}")
            continue

        # Check for duplicates using arXiv ID
        if arxiv_id in seen_ids:
            print(f"Duplicate paper detected with ID {arxiv_id}, skipping.")
            continue
        seen_ids.add(arxiv_id)  # Add ID to set of seen IDs

        # Extract the authors
        authors = []
        for li in paper_div.find_all("li"):
            author = li.get("title")
            if author:
                authors.append(author)

        # Create the full link to the paper
        full_link = f"https://arxiv.org/abs/{arxiv_id}"

        # Visit the arXiv page to check for GitHub links
        paper_page = requests.get(full_link)
        paper_soup = BeautifulSoup(paper_page.content, "html.parser")

        # Extract GitHub repository link if present
        github_repo = None
        github_link_tag = paper_soup.find("a", href=re.compile(r"github\.com"))
        if github_link_tag:
            github_repo = github_link_tag["href"]

        # Attempt to download the PDF
        pdf_path = os.path.join(temp_pdf_dir, f"{arxiv_id}.pdf")
        if download_pdf(arxiv_id, pdf_path):
            papers.append(
                {
                    "title": title,
                    "authors": ", ".join(authors),
                    "link": full_link,
                    "github_repo": github_repo,  # Add GitHub repository if present
                    "pdf_path": pdf_path,
                }
            )
        else:
            print(f"Failed to download PDF for {arxiv_id}")

    # Ensure 'data' directory exists
    data_dir = "data"
    print(f"Ensuring data directory exists: {data_dir}")
    os.makedirs(data_dir, exist_ok=True)  # Create 'data' directory if it doesn't exist
    data_file_path = os.path.join(data_dir, f"{date}_papers.json")

    # Write data to JSON
    print(f"Writing data to {data_file_path}")
    with open(data_file_path, "w") as f:
        json.dump(papers, f, indent=2)
    print(f"Saved {len(papers)} papers' information and PDFs")


if __name__ == "__main__":
    pull_hf_daily("2024-09-26")
